.PHONY: all clean install update

ADNS = 		@ADNS_SUBDIR@
CXX =		@CXX@
CXXFLAGS =	-g -DSBNC @SSL_DEF@ -fPIC
CFLAGS =	@SSL_DEF@ @CFLAGS@ @CPPFLAGS@ @DEFS@ -fPIC
LDFLAGS =	@LDFLAGS@ @LIBS@ @SSL_LIBS@ @ADNS_LIBS@
OBJS =		Connection.o Module.o Channel.o FloodControl.o ClientConnection.o utility.o Queue.o BouncerUser.o IRCConnection.o BouncerConfig.o BouncerCore.o sbnc.o IdentSupport.o BouncerLog.o Nick.o unix.o md5-c/md5c.o Match.o TrafficStats.o Keyring.o Banlist.o Timer.o FIFOBuffer.o @LIBOBJS@
MD5OBJS = 	md5util/md5util.o md5util/StdAfx.o md5-c/md5c.o @LIBOBJS@
DL_LIB =	@DL_LIB@
export DL_LIB
export CFLAGS

all : sbnc sbnc.so md5tool

md5tool : $(MD5OBJS)
	$(CXX) -o md5util/$@ $(MD5OBJS) $(LDFLAGS)
	@cp md5util/$@ md5tool

sbnc.so : $(OBJS) @ADNS_LIBS@
	g++ -g -shared -fPIC -o $@ $(OBJS) $(LDFLAGS)

sbnc :
	$(MAKE) -C sbncloader
	-rm sbnc
	cp sbncloader/sbncloader ./sbnc

clean :
	-rm $(OBJS) $(MD5OBJS)
	$(MAKE) -C sbncloader clean

install : sbnc sbnc.so
	@if [ ! -d ~/sbnc ]; then mkdir ~/sbnc; fi
	@cp sbnc ~/sbnc
	@cp sbnc.so ~/sbnc
	@cp -R scripts ~/sbnc
	@if [ ! -d ~/sbnc/users ]; then mkdir ~/sbnc/users; fi
	@cp users/example.conf ~/sbnc/users
	@if [ ! -f ~/sbnc/sbnc.conf ]; then cp sbnc.conf ~/sbnc; fi
	@if [ ! -f ~/sbnc/sbnc.tcl ]; then cp sbnc.tcl ~/sbnc; fi
	@cp README* ~/sbnc
	@echo "shroudBNC was installed in ${HOME}/sbnc. Please change to this directory before you proceed with editing your configuration files."

update : sbnc.so
	@echo `date +%Y%m%d%H%M%S` > /tmp/ts.tag;
	@cp sbnc.so ~/sbnc/sbnc-`cat /tmp/ts.tag`.so
	@echo "${HOME}/sbnc/sbnc-`cat /tmp/ts.tag`.so" > ~/sbnc/sbnc.ipc
	@echo "Reloading shroudBNC..."
	@-kill -USR1 `cat ~/sbnc/sbnc.pid`
	@echo "New shroudBNC module was copied to ${HOME}/sbnc/sbnc-`cat /tmp/ts.tag`.so"
	@echo "You might need to update your TCL scripts manually."
	@-rm /tmp/ts.tag

adns/libadns.a :
ifeq ($(ADNS),yes)
	$(MAKE) -C adns
endif
